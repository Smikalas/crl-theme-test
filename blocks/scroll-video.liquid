{% doc %}
  @prompt
    A video block that plays only while scrolling using GSAP ScrollTrigger.
    Video plays when scrolling down and pauses when scrolling stops.
    Uses smooth scrub animation to control video playback based on scroll position.
{% enddoc %}

{% assign scroll_video_id = block.id | replace: '_', '' | downcase %}

{% style %}
  .scroll-video-container-{{ scroll_video_id }} {
    position: relative;
    width: 100%;
    height: {{ block.settings.block_height }}vh;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: {{ block.settings.background_color }};
  }

  .scroll-video-wrapper-{{ scroll_video_id }} {
    position: relative;
    width: 100%;
    max-width: {{ block.settings.max_width }}px;
    height: 100%;
    border-radius: {{ block.settings.border_radius }}px;
    overflow: hidden;
  }

  .scroll-video-{{ scroll_video_id }} {
    width: 100%;
    height: 100%;
    object-fit: {{ block.settings.object_fit }};
    object-position: {{ block.settings.object_position }};
  }

  .scroll-video-placeholder-{{ scroll_video_id }} {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f0f0f0;
    color: #666;
    font-size: 18px;
    border-radius: {{ block.settings.border_radius }}px;
  }

  .scroll-video-overlay-{{ scroll_video_id }} {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      45deg,
      transparent,
      {{ block.settings.overlay_color }}
    );
    opacity: {{ block.settings.overlay_opacity }};
    pointer-events: none;
    z-index: 1;
  }

  .scroll-video-content-{{ scroll_video_id }} {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    z-index: 2;
    color: {{ block.settings.text_color }};
    max-width: 80%;
  }

  .scroll-video-title-{{ scroll_video_id }} {
    font-size: {{ block.settings.title_size }}px;
    font-weight: {{ block.settings.title_weight }};
    margin-bottom: 10px;
    opacity: 0;
    transform: translateY(20px);
  }

  .scroll-video-description-{{ scroll_video_id }} {
    font-size: {{ block.settings.description_size }}px;
    opacity: 0;
    transform: translateY(20px);
    line-height: 1.6;
  }

  .scroll-progress-indicator-{{ scroll_video_id }} {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 200px;
    height: 4px;
    background-color: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
    z-index: 3;
  }

  .scroll-progress-bar-{{ scroll_video_id }} {
    height: 100%;
    background-color: {{ block.settings.progress_color }};
    border-radius: 2px;
    width: 0%;
    transition: width 0.1s ease;
  }

  @media screen and (max-width: 768px) {
    .scroll-video-container-{{ scroll_video_id }} {
      height: {{ block.settings.mobile_height }}vh;
    }
    
    .scroll-video-title-{{ scroll_video_id }} {
      font-size: {{ block.settings.title_size | times: 0.8 }}px;
    }
    
    .scroll-video-description-{{ scroll_video_id }} {
      font-size: {{ block.settings.description_size | times: 0.9 }}px;
    }
  }
{% endstyle %}

<!-- Load GSAP and ScrollTrigger -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>
<script src="{{ 'scroll-video.js' | asset_url }}" defer></script>

<div class="scroll-video-container-{{ scroll_video_id }}" {{ block.shopify_attributes }}>
  <div class="scroll-video-wrapper-{{ scroll_video_id }}">
    {% if block.settings.video != blank %}
      <video
        id="scroll-video-{{ scroll_video_id }}"
        class="scroll-video-{{ scroll_video_id }}"
        muted
        playsinline
        preload="metadata"
        {% if block.settings.poster_image != blank %}poster="{{ block.settings.poster_image | image_url: width: 1920 }}"{% endif %}
      >
        {%- for source in block.settings.video.sources -%}
          <source src="{{ source.url }}" type="{{ source.mime_type }}">
        {%- endfor -%}
        Your browser does not support the video tag.
      </video>
    {% elsif block.settings.video_url != blank %}
      <video
        id="scroll-video-{{ scroll_video_id }}"
        class="scroll-video-{{ scroll_video_id }}"
        muted
        playsinline
        preload="metadata"
        {% if block.settings.poster_image != blank %}poster="{{ block.settings.poster_image | image_url: width: 1920 }}"{% endif %}
      >
        <source src="{{ block.settings.video_url }}" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    {% else %}
      <div class="scroll-video-placeholder-{{ scroll_video_id }}">
        <div>
          <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8 5v14l11-7z"/>
          </svg>
          <p>Upload a video to see the scroll effect</p>
        </div>
      </div>
    {% endif %}

    {% if block.settings.show_overlay %}
      <div class="scroll-video-overlay-{{ scroll_video_id }}"></div>
    {% endif %}

    {% if block.settings.show_content %}
      <div class="scroll-video-content-{{ scroll_video_id }}">
        {% if block.settings.title != blank %}
          <h2 class="scroll-video-title-{{ scroll_video_id }}">{{ block.settings.title }}</h2>
        {% endif %}
        {% if block.settings.description != blank %}
          <p class="scroll-video-description-{{ scroll_video_id }}">{{ block.settings.description }}</p>
        {% endif %}
      </div>
    {% endif %}

    {% if block.settings.show_progress %}
      <div class="scroll-progress-indicator-{{ scroll_video_id }}">
        <div class="scroll-progress-bar-{{ scroll_video_id }}"></div>
      </div>
    {% endif %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const video = document.getElementById('scroll-video-{{ scroll_video_id }}');
  if (!video) return;

  // Initialize with custom options
  const options = {
    scrubSmoothness: {{ block.settings.scrub_smoothness }},
    speedBasedPlayback: {{ block.settings.speed_based_playback }},
    mobileTouch: {{ block.settings.mobile_touch_control }},
    showProgress: {{ block.settings.show_progress }}
  };

  // Wait for ScrollVideoComponent to be available
  const initVideo = () => {
    if (typeof ScrollVideoComponent !== 'undefined') {
      new ScrollVideoComponent(video, options);
    } else {
      setTimeout(initVideo, 100);
    }
  };

  initVideo();
});
</script>

{% schema %}
{
  "name": "Scroll Video",
  "settings": [
    {
      "type": "header",
      "content": "Video Settings"
    },
    {
      "type": "video",
      "id": "video",
      "label": "Video",
      "info": "Upload a video file"
    },
    {
      "type": "url",
      "id": "video_url",
      "label": "Video URL",
      "info": "Direct link to MP4 video file (use this OR upload a video above)"
    },
    {
      "type": "image_picker",
      "id": "poster_image",
      "label": "Poster Image",
      "info": "Preview image shown before video loads"
    },
    {
      "type": "select",
      "id": "object_fit",
      "label": "Video Fit",
      "options": [
        {
          "value": "cover",
          "label": "Cover"
        },
        {
          "value": "contain",
          "label": "Contain"
        },
        {
          "value": "fill",
          "label": "Fill"
        }
      ],
      "default": "cover"
    },
    {
      "type": "select",
      "id": "object_position",
      "label": "Video Position",
      "options": [
        {
          "value": "center center",
          "label": "Center"
        },
        {
          "value": "top center",
          "label": "Top"
        },
        {
          "value": "bottom center",
          "label": "Bottom"
        },
        {
          "value": "left center",
          "label": "Left"
        },
        {
          "value": "right center",
          "label": "Right"
        }
      ],
      "default": "center center"
    },
    {
      "type": "header",
      "content": "Scroll Settings"
    },
    {
      "type": "range",
      "id": "scrub_smoothness",
      "min": 0.1,
      "max": 3,
      "step": 0.1,
      "unit": "s",
      "label": "Scroll Smoothness",
      "default": 1,
      "info": "Lower values = more responsive, higher values = smoother"
    },
    {
      "type": "checkbox",
      "id": "speed_based_playback",
      "label": "Speed-based Playback",
      "default": false,
      "info": "Adjust video speed based on scroll speed"
    },
    {
      "type": "checkbox",
      "id": "mobile_touch_control",
      "label": "Enhanced Mobile Touch",
      "default": true,
      "info": "Optimize touch scrolling on mobile devices"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "block_height",
      "min": 50,
      "max": 150,
      "step": 5,
      "unit": "vh",
      "label": "Block Height",
      "default": 100
    },
    {
      "type": "range",
      "id": "mobile_height",
      "min": 40,
      "max": 100,
      "step": 5,
      "unit": "vh",
      "label": "Mobile Height",
      "default": 70
    },
    {
      "type": "range",
      "id": "max_width",
      "min": 800,
      "max": 2000,
      "step": 50,
      "unit": "px",
      "label": "Max Width",
      "default": 1200
    },
    {
      "type": "range",
      "id": "border_radius",
      "min": 0,
      "max": 30,
      "step": 2,
      "unit": "px",
      "label": "Border Radius",
      "default": 0
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#000000"
    },
    {
      "type": "header",
      "content": "Overlay"
    },
    {
      "type": "checkbox",
      "id": "show_overlay",
      "label": "Show Overlay",
      "default": false
    },
    {
      "type": "color",
      "id": "overlay_color",
      "label": "Overlay Color",
      "default": "rgba(0,0,0,0.3)"
    },
    {
      "type": "range",
      "id": "overlay_opacity",
      "min": 0,
      "max": 1,
      "step": 0.1,
      "label": "Overlay Opacity",
      "default": 0.3
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "checkbox",
      "id": "show_content",
      "label": "Show Content",
      "default": false
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Scroll Video"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "default": "This video plays as you scroll"
    },
    {
      "type": "range",
      "id": "title_size",
      "min": 16,
      "max": 60,
      "step": 2,
      "unit": "px",
      "label": "Title Size",
      "default": 32
    },
    {
      "type": "range",
      "id": "description_size",
      "min": 12,
      "max": 24,
      "step": 1,
      "unit": "px",
      "label": "Description Size",
      "default": 16
    },
    {
      "type": "select",
      "id": "title_weight",
      "label": "Title Weight",
      "options": [
        {
          "value": "300",
          "label": "Light"
        },
        {
          "value": "400",
          "label": "Regular"
        },
        {
          "value": "500",
          "label": "Medium"
        },
        {
          "value": "600",
          "label": "Semi Bold"
        },
        {
          "value": "700",
          "label": "Bold"
        }
      ],
      "default": "600"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Progress Indicator"
    },
    {
      "type": "checkbox",
      "id": "show_progress",
      "label": "Show Progress Bar",
      "default": true
    },
    {
      "type": "color",
      "id": "progress_color",
      "label": "Progress Color",
      "default": "#ffffff"
    }
  ],
  "presets": [
    {
      "name": "Scroll Video",
      "settings": {
        "block_height": 100,
        "mobile_height": 70,
        "scrub_smoothness": 1,
        "show_progress": true,
        "show_content": false,
        "show_overlay": false
      }
    }
  ]
}
{% endschema %}
